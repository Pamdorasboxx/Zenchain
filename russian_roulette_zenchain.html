<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>zenchain - Russian Roulette</title>
<style>
body{background:linear-gradient(180deg,#030402,#000);color:#a7cfa3;font-family:Arial,sans-serif;display:flex;flex-direction:column;align-items:center;padding:20px;font-size:18px}
header{text-align:center;margin-bottom:20px}
.brand{font-size:64px;font-weight:bold;color:#66ff88}
.game-title{font-size:36px;color:#fff;margin-top:5px}
.top-id{font-size:18px;margin-top:5px;color:#66ff88}
.revolver-wrap{background:linear-gradient(180deg,#021509,#001006);padding:30px;border-radius:12px;margin-bottom:20px;display:flex;justify-content:center;flex-wrap:wrap;max-width:100%;overflow:hidden}
.chamber{width:60px;height:60px;border-radius:50%;background:#07120a;border:2px solid #0b2b16;display:inline-block;margin:10px;position:relative;transition:all .3s ease;box-sizing:border-box}
.chamber.bullet{background:#00ff66}
.chamber.current{border-color:#66ff88;border-width:3px;transform:scale(1.3)}
.controls{margin-bottom:20px;display:flex;flex-direction:column;align-items:center}
.wager-buttons{display:flex;gap:10px;margin:10px 0}
button{padding:15px 30px;border:none;border-radius:12px;cursor:pointer;font-weight:bold;font-size:20px;background:linear-gradient(90deg,#00ff00,#ffff00);color:#021202}
select{padding:10px 14px;font-size:18px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.2);color:#a7cfa3}
.players-list{margin-top:15px;text-align:center;font-size:22px}
.player{margin-bottom:10px;transition:all .3s ease}
.player.dead{color:#ff3c3c;font-weight:bold;text-decoration:line-through}
.explosion{animation:explode .5s ease forwards}
@keyframes explode{0%{transform:scale(1);opacity:1}50%{transform:scale(1.5);opacity:.8}100%{transform:scale(0);opacity:0}}
.winner-modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#021202;color:#66ff88;padding:50px;border-radius:15px;display:none;font-size:36px;text-align:center;border:3px solid #66ff88;z-index:9999}
.winner-modal button{margin-top:30px;font-size:22px;padding:10px 20px}
.connect-wallet-btn{margin-top:20px;background:linear-gradient(90deg,#00aaff,#0077ff);color:#fff;padding:15px 30px;font-size:20px;border:none;border-radius:12px;cursor:pointer;font-weight:bold}
.revolver-inner{width:460px;height:200px;display:flex;align-items:center;justify-content:center;position:relative;overflow:visible}
.cylinder{width:320px;height:320px;position:relative;border-radius:50%;display:flex;align-items:center;justify-content:center}
.cylinder .chamber{position:absolute;margin:0}
.chamber.pos0{left:50%;top:4%;transform:translate(-50%,0)}
.chamber.pos1{left:82%;top:25%;transform:translate(-50%,-50%)}
.chamber.pos2{left:82%;top:75%;transform:translate(-50%,-50%)}
.chamber.pos3{left:50%;top:96%;transform:translate(-50%,-100%)}
.chamber.pos4{left:18%;top:75%;transform:translate(-50%,-50%)}
.chamber.pos5{left:18%;top:25%;transform:translate(-50%,-50%)}
@media(max-width:600px){.brand{font-size:40px}.game-title{font-size:24px}button{font-size:16px;padding:10px 18px}.chamber{width:46px;height:46px}.cylinder{width:260px;height:260px}}
</style>
<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
</head>
<body>
<header><div class="brand">zenchain</div><div class="game-title">Russian Roulette</div><div class="top-id">@heliasayadi</div></header>
<div class="revolver-wrap"><div class="revolver-inner"><div class="cylinder" id="cylinder"></div></div></div>
<div class="controls">
<label style="font-size:20px">Players: <select id="playerCount"><option>2</option><option>3</option><option>4</option><option>5</option><option selected>6</option></select></label>
<div class="wager-buttons"><button data-wager="10">10</button><button data-wager="50">50</button><button data-wager="100">100</button></div>
<div style="margin-top:8px"><button id="startBtn">Start (Load)</button><button id="fireBtn">Fire</button><button id="nextBtn">Next Turn</button></div>
<button class="connect-wallet-btn" id="connectWalletBtn">Connect Wallet</button>
</div>
<div class="players-list" id="playersList"></div>
<div class="winner-modal" id="winnerModal"><div id="winnerText"></div><button id="closeWinner">Close</button></div>

<script>
const cylinder=document.getElementById('cylinder');
const chamberPositions=['pos0','pos1','pos2','pos3','pos4','pos5'];

function buildChambers(bulletIndex,currentIndex){
  cylinder.innerHTML='';
  for(let i=0;i<6;i++){
    const d=document.createElement('div');
    d.className='chamber '+chamberPositions[i];
    d.dataset.index=i;
    if(i===bulletIndex) d.classList.add('bullet');
    if(i===currentIndex) d.classList.add('current');
    d.innerText=i+1;
    cylinder.appendChild(d);
  }
}

const playerCountEl=document.getElementById('playerCount');
const playersListEl=document.getElementById('playersList');
const startBtn=document.getElementById('startBtn');
const fireBtn=document.getElementById('fireBtn');
const nextBtn=document.getElementById('nextBtn');
const winnerModal=document.getElementById('winnerModal');
const winnerText=document.getElementById('winnerText');
const closeWinner=document.getElementById('closeWinner');

let players=[];let currentIndex=0;let bulletIndex=null;let cylinderPosition=0;let gameActive=false;let pot=0;let selectedWager=0;let reshuffleEachRound=false;

function renderPlayers(){
  playersListEl.innerHTML='';
  players.forEach((p,i)=>{
    const div=document.createElement('div');
    div.className='player';div.id='player-'+i;
    div.innerText=`${p.name}: ${p.alive?'Alive':'Dead'} - ${p.stake} ZTC`;
    if(!p.alive) div.classList.add('dead');
    playersListEl.appendChild(div);
  });
}

function initPlayers(){
  players=[];
  const n=parseInt(playerCountEl.value);
  for(let i=0;i<n;i++) players.push({name:'Player '+(i+1),alive:true,stake:selectedWager});
  pot=selectedWager*n;currentIndex=0;
}

function explodeEffect(){
  const expl=document.createElement('div');
  expl.className='explosion';
  expl.style.position='fixed';expl.style.width='80px';expl.style.height='80px';
  expl.style.background='radial-gradient(circle,#ff3c3c,#ff0000)';
  expl.style.borderRadius='50%';expl.style.left='50%';expl.style.top='50%';
  expl.style.transform='translate(-50%,-50%)';
  document.body.appendChild(expl);
  setTimeout(()=>expl.remove(),500);
}

// --- Wallet & Token setup ---
let web3, selectedAccount=null;
const ZENCHAIN_TESTNET = {
  chainId: '0x20d8',
  chainName: 'ZenChain Testnet',
  nativeCurrency: { name: 'ZTC', symbol: 'ZTC', decimals: 18 },
  rpcUrls: ['https://zenchain-testnet.api.onfinality.io/public'],
  blockExplorerUrls: ['https://explorer-testnet.zenchain.io']
};

const TOKEN_ADDRESS="0x0000000000000000000000000000000000000800";
const TOKEN_ABI=[{"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"name":"","type":"bool"}],"type":"function"}];

async function connectWallet(){
  if(!window.ethereum) return alert("MetaMask not found!");
  web3=new Web3(window.ethereum);
  try{
    const accounts=await ethereum.request({method:'eth_requestAccounts'});
    selectedAccount=accounts[0];
    const chainId=await ethereum.request({method:'eth_chainId'});
    if(chainId!==ZENCHAIN_TESTNET.chainId){
      await ethereum.request({method:'wallet_addEthereumChain',params:[ZENCHAIN_TESTNET]});
    }
    alert("Wallet connected: "+selectedAccount);
  }catch(e){console.error(e);alert("Wallet connection failed");}
}

async function sendZTCReward(amount){
  if(!selectedAccount) return alert("Wallet not connected!");
  const token=new web3.eth.Contract(TOKEN_ABI,TOKEN_ADDRESS);
  const amountWei=web3.utils.toWei(amount.toString(),'ether');
  try{
    const tx=await token.methods.transfer(selectedAccount,amountWei).send({from:selectedAccount});
    alert(`Prize sent!\nTX: ${tx.transactionHash}`);
  }catch(err){console.error(err);alert("Transfer failed: "+err.message);}
}

function checkWinner(){
  const alivePlayers=players.filter(p=>p.alive);
  if(alivePlayers.length===1){
    winnerText.innerText=`ðŸ† Winner: ${alivePlayers[0].name}\nPrize: ${pot} ZTC`;
    winnerModal.style.display='block';gameActive=false;
    sendZTCReward(pot);
  }
}

function updateUI(){buildChambers(bulletIndex,cylinderPosition);renderPlayers();}

document.querySelectorAll('button[data-wager]').forEach(b=>{
  b.addEventListener('click',()=>{
    selectedWager=parseInt(b.getAttribute('data-wager'));
    document.querySelectorAll('button[data-wager]').forEach(x=>x.style.boxShadow='none');
    b.style.boxShadow='0 8px 30px rgba(255,255,0,0.12)';
  });
});

startBtn.addEventListener('click',()=>{
  if(selectedWager===0){alert('Please pick a wager.');return;}
  reshuffleEachRound=confirm('Reshuffle bullet each round? OK=Yes, Cancel=No');
  initPlayers();bulletIndex=Math.floor(Math.random()*6);
  cylinderPosition=0;gameActive=true;updateUI();
});

fireBtn.addEventListener('click',()=>{
  if(!gameActive)return;
  const player=players[currentIndex];
  const chamberEl=cylinder.querySelector(`.chamber[data-index='${cylinderPosition}']`);
  chamberEl.style.transform='scale(1.6)';
  setTimeout(()=>chamberEl.style.transform='scale(1.3)',300);
  if(cylinderPosition===bulletIndex){
    player.alive=false;
    const pEl=document.getElementById('player-'+currentIndex);
    if(pEl)pEl.classList.add('dead');explodeEffect();
  }else{
    chamberEl.style.boxShadow='0 8px 24px rgba(102,255,136,0.12)';
    setTimeout(()=>chamberEl.style.boxShadow='none',350);
  }
  updateUI();
  if(reshuffleEachRound&&player.alive){bulletIndex=Math.floor(Math.random()*6);cylinderPosition=0;}
  else{cylinderPosition=(cylinderPosition+1)%6;}
  checkWinner();
});

nextBtn.addEventListener('click',()=>{
  if(!gameActive)return;
  const n=players.length;
  for(let i=1;i<=n;i++){
    const idx=(currentIndex+i)%n;
    if(players[idx].alive){currentIndex=idx;break;}
  }
  updateUI();
});

closeWinner.addEventListener('click',()=>{winnerModal.style.display='none';location.reload();});
buildChambers(null,null);

document.getElementById('connectWalletBtn').addEventListener('click',connectWallet);
</script>
</body>
</html>